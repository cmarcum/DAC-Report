---
output: 
 bookdown::word_document2: default
params:
  title: "title"
  author: "author"
  start.date: "start.date"
  end.date: "end.date"
  dac: "DAC"
  timeline.summary.table: "timeline.summary.table"
  study.summary.table: "study.summary.table"
  study.status.table: "study.status.table"
--- 

---
title: `r params$title`
author: `r params$author`
date: `r format(Sys.time(), '%d %B, %Y')`
---

```{r, include=FALSE}
# Loads variables to be reported
library(ggplot2)
library(tidyverse)
dac <- params$dac

dac.total.dars <- nrow(nih_dac_action_table[nih_dac_action_table['DAC'] == dac,])
total.number.of.projects <- length(unique(nih_dac_action_table[nih_dac_action_table['DAC'] == dac,'Project']))

dac.row <- timeline.summary.table[timeline.summary.table['DAC'] == dac,]

num.dars.in.window <- dac.row[,'TotalRequests']
number.of.accepted <- dac.row[,'TotalApproved']
number.of.rejected <- dac.row[,'TotalRejected']

avg.accept <- dac.row[,'AvgApprovalTime']
avg.reject <- dac.row[,'AvgRejectionTime']

dac.total.dars <- nrow(nih_dac_action_table[nih_dac_action_table['DAC'] == dac,])
dac.total.project <- length(unique(nih_dac_action_table[nih_dac_action_table['DAC'] == dac,'Project']))

avg.final <- (avg.accept*number.of.accepted + avg.reject*number.of.rejected) / (number.of.accepted+number.of.rejected)
```

The `r dac` Data Access Committee (DAC) currently manages `r dac.total.dars` data access requests (DARs) for access to `r total.number.of.projects` projects in dbGaP.  

# Data Access Requests
Between `r params$start.date` and `r params$end.date` the DAC reviewed `r num.dars.in.window` DARs. Of these, `r number.of.accepted` were accepted while `r number.of.rejected` were rejected.  The average amount of time from when the Principle Investigator (PI) submited a DAR to the final decision by the DAC was `r round(avg.final,1)` days.  The average time to an accepted decision was `r round(avg.accept,1)` days, while the average time to a rejected decision was `r round(avg.reject,1)` days.  Figure \@ref(fig:compline) is a barplot comparing the `r dac` DAC to time to final decision to the average across all NIH DACs during the same time interval.  

```{r compline, fig.cap="Comparison of Time to Final Decision", echo=FALSE, warning=FALSE ,message=FALSE}
timeline.summary.table <- timeline.summary.table %>% mutate(ToHighlight = ifelse( DAC == params$dac, "yes", "no" ))
timeline.summary.table$AvgApprovalTime <- as.numeric(timeline.summary.table$AvgApprovalTime, units="days")
timeline.summary.table<- timeline.summary.table[order(timeline.summary.table$AvgApprovalTime, decreasing=TRUE),]
timeline.summary.table$DAC <- factor(timeline.summary.table$DAC, levels=unique(as.character(timeline.summary.table$DAC)))
p <- ggplot(data=timeline.summary.table, aes(x=DAC, y=AvgApprovalTime, fill = ToHighlight)) +
  geom_bar(stat="identity") +
  # geom_text(aes(label=paste(round(AvgApprovalTime,1),'days'))) +
  scale_y_continuous(breaks = seq(0, max(timeline.summary.table$AvgApprovalTime, na.rm = TRUE), by = 7)) +
  scale_fill_manual(values = c("yes"="cornflowerblue","no"="gray"), guide = FALSE) +
  coord_flip() +
  ylab("Average Approval Time (days)")
p
```

```{r include=FALSE}
study.summary.table.ordered <- study.summary.table[order(-study.summary.table$TotalRequest),]
total.approved.dar <- sum(study.summary.table.ordered$TotalApproved)
total.dar.downloaded <- sum(study.summary.table.ordered$TotalDownload)
download.percentage <- round(total.dar.downloaded*100/total.approved.dar,2)
phs.popular.all <- study.summary.table.ordered[1,]['StudyAccesion']
phs.popular.all.study.name <- study.summary.table.ordered[1,]['Study Name']
phs.popular.all.dac <- study.summary.table.ordered[1,]['DAC']
phs.popular.all.total.request <- study.summary.table.ordered[1,]['TotalRequest']

dac.study.summary.table <- study.summary.table[study.summary.table['DAC'] == dac,]
dac.study.summary.table.ordered <- dac.study.summary.table[order(-dac.study.summary.table$TotalRequest),]
phs.popular.this.dac <- dac.study.summary.table.ordered[1,]['StudyAccesion']
phs.popular.this.dac.study.name <- dac.study.summary.table.ordered[1,]['Study Name']
phs.popular.this.dac.total.request <- dac.study.summary.table.ordered[1,]['TotalRequest']
```


Among all approved DARs, PIs have downloaded `r total.dar.downloaded` (`r download.percentage`%) datasets.  During this reporting period, study number `r phs.popular.all` (`r phs.popular.all.study.name`) from `r phs.popular.all.dac` was the most commonly requested dataset with `r phs.popular.all.total.request` total requests while `r phs.popular.this.dac` (`r phs.popular.this.dac.study.name`) has been the most requested dataset from the `r dac` DAC with `r phs.popular.this.dac.total.request` requests. 


```{r fig.cap="Comparison of Cummulative DAR Made and Studies Released Per Month Across All DACs", echo=FALSE, warning=FALSE ,message=FALSE}

p <- ggplot(study.status.table, aes(x=Month)) +
  geom_line(aes(y=TotalRequestsCummulative, colour="Total Requests"), size=2) +
  geom_line(aes(y=StudiesReleasedCummulative, colour="Studies Released"), size=2) +
  scale_color_manual("",
                     values = c("Total Requests"="cornflowerblue", "Studies Released"="coral3")) +
  theme(legend.position = "bottom") +
  scale_y_continuous(trans='log2', n.breaks = 8) +
  xlab("Year") +
  ylab("DAR Total / Studies Released (log scale)")
  
rect <- data.frame(xmin=as.Date(lubridate::floor_date(as.Date(params$start.date))), xmax=as.Date(lubridate::floor_date(as.Date(params$end.date))), ymin=0, ymax=Inf)

p <- p + geom_rect(data=rect, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax),
              color="gray20",
              alpha=0.2,
              inherit.aes = FALSE)
p
```



# Study Registrations


---
This report was prepared using the DACReportingTool package for R, build `r packageVersion("DACReportingTool")` by Mr. Hoyin Chu and Dr. Christopher Steven Marcum. 
