---
output: 
 bookdown::word_document2: default
params:
  title: "title"
  author: "author"
  start.date: "start.date"
  end.date: "end.date"
  dac: "DAC"
  timeline.summary.table: "timeline.summary.table"
--- 

---
title: `r params$title`
author: `r params$author`
date: `r format(Sys.time(), '%d %B, %Y')`
---

```{r, include=FALSE}
# Loads variables to be reported
library(ggplot2)
library(tidyverse)
dac <- params$dac

print(dac)
print(nih_dac_action_table[nih_dac_action_table['DAC'] == dac,])
dac.total.dars <- nrow(nih_dac_action_table[nih_dac_action_table['DAC'] == dac,])
total.number.of.projects <- length(unique(nih_dac_action_table[nih_dac_action_table['DAC'] == dac,'Project']))

print(dac.total.dars)

dac.row <- timeline.summary.table[timeline.summary.table['DAC'] == dac,]

num.dars.in.window <- dac.row[,'TotalRequests']
number.of.accepted <- dac.row[,'TotalApproved']
number.of.rejected <- dac.row[,'TotalRejected']

avg.accept <- dac.row[,'AvgApprovalTime']
avg.reject <- dac.row[,'AvgRejectionTime']

dac.total.dars <- nrow(nih_dac_action_table[nih_dac_action_table['DAC'] == dac,])
dac.total.project <- length(unique(nih_dac_action_table[nih_dac_action_table['DAC'] == dac,'Project']))

avg.final <- (avg.accept*number.of.accepted + avg.reject*number.of.rejected) / (number.of.accepted+number.of.rejected)
```

The `r dac` Data Access Committee (DAC) currently manages `r dac.total.dars` data access requests (DARs) for access to `r total.number.of.projects` projects in dbGaP.  

# Data Access Requests
Between `r params$start.date` and `r params$end.date` the DAC reviewed `r num.dars.in.window` DARs. Of these, `r number.of.accepted` were accepted while `r number.of.rejected` were rejected.  The average amount of time from when the Principle Investigator (PI) submited a DAR to the final decision by the DAC was `r round(avg.final,1)` days.  The average time to an accepted decision was `r round(avg.accept,1)` days, while the average time to a rejected decision was `r round(avg.reject,1)` days.  Figure \@ref(fig:compline) is a barplot comparing the `r dac` DAC to time to final decision to the average across all NIH DACs during the same time interval.  

```{r compline, fig.cap="Comparison of Time to Final Decision", echo=FALSE, warning=FALSE ,message=FALSE}
timeline.summary.table <- timeline.summary.table %>% mutate(ToHighlight = ifelse( DAC == params$dac, "yes", "no" ))
timeline.summary.table$AvgApprovalTime <- as.numeric(timeline.summary.table$AvgApprovalTime, units="days")
timeline.summary.table<- timeline.summary.table[order(timeline.summary.table$AvgApprovalTime, decreasing=TRUE),]
timeline.summary.table$DAC <- factor(timeline.summary.table$DAC, levels=unique(as.character(timeline.summary.table$DAC)))
p <- ggplot(data=timeline.summary.table, aes(x=DAC, y=AvgApprovalTime, fill = ToHighlight)) +
  geom_bar(stat="identity") +
  # geom_text(aes(label=paste(round(AvgApprovalTime,1),'days'))) +
  scale_y_continuous(breaks = seq(0, max(timeline.summary.table$AvgApprovalTime, na.rm = TRUE), by = 7)) +
  scale_fill_manual(values = c("yes"="cornflowerblue","no"="gray"), guide = FALSE) +
  coord_flip() +
  ylab("Average Approval Time (days)")
p
```

Among all approved DARs, PIs have downloaded `r number.with.downloads` datasets.  

# Study Registrations

---
This report was prepared using the DACReportingTool package for R, build 0.0.1 by Mr. Hoyin Chu and Dr. Christopher Steven Marcum. 
