---
output: 
 bookdown::word_document2: default
params:
  title: "title"
  author: "author"
  start.date: "start.date"
  end.date: "end.date"
  dac: "DAC"
  timeline.summary.table: "timeline.summary.table"
  study.summary.table: "study.summary.table"
  study.status.table.all: "study.status.table.all"
  study.status.table.dac: "study.status.table.dac"
  pi.requests.table.overall: "pi.requests.table.overall"
  pi.requests.table.selected.time: "pi.requests.table.selected.time"
  approval.time.moving.avg.table: "approval.time.moving.avg.table"
--- 

---
title: `r params$title`
author: `r params$author`
date: `r format(Sys.time(), '%d %B, %Y')`
---

```{r, include=FALSE}
# Loads variables to be reported
library(ggplot2)
library(tidyverse)
dac <- params$dac

dac.total.dars <- nrow(nih_dac_action_table[nih_dac_action_table['DAC'] == dac,])
total.number.of.projects <- length(unique(nih_dac_action_table[nih_dac_action_table['DAC'] == dac,'Project']))

dac.row <- timeline.summary.table[timeline.summary.table['DAC'] == dac,]

num.dars.in.window <- dac.row[,'TotalRequests']
number.of.accepted <- dac.row[,'TotalApproved']
number.of.rejected <- dac.row[,'TotalRejected']

avg.accept <- dac.row[,'AvgApprovalTime']
avg.reject <- dac.row[,'AvgRejectionTime']

dac.total.dars <- nrow(nih_dac_action_table[nih_dac_action_table['DAC'] == dac,])
dac.total.project <- length(unique(nih_dac_action_table[nih_dac_action_table['DAC'] == dac,'Project']))

avg.final <- (avg.accept*number.of.accepted + avg.reject*number.of.rejected) / (number.of.accepted+number.of.rejected)
```

The `r dac` Data Access Committee (DAC) currently manages `r dac.total.dars` data access requests (DARs) for access to `r total.number.of.projects` projects in dbGaP.  

# Data Access Requests
Between `r params$start.date` and `r params$end.date` `r dac` reviewed `r num.dars.in.window` DARs. Of these, `r number.of.accepted` were accepted while `r number.of.rejected` were rejected.  The average amount of time from when the Principle Investigator (PI) submited a DAR to the final decision by the DAC was `r round(avg.final,1)` days.  The average time to an accepted decision was `r round(avg.accept,1)` days, while the average time to a rejected decision was `r round(avg.reject,1)` days.  Figure \@ref(fig:compline) is a barplot comparing the `r dac` DAC to time to final decision to the average across all NIH DACs during the same time interval.  

```{r compline, fig.cap="Comparison of Time to Final Decision", echo=FALSE, warning=FALSE ,message=FALSE}
timeline.summary.table <- timeline.summary.table %>% mutate(ToHighlight = ifelse( DAC == params$dac, "yes", "no" ))
timeline.summary.table$AvgApprovalTime <- as.numeric(timeline.summary.table$AvgApprovalTime, units="days")
timeline.summary.table<- timeline.summary.table[order(timeline.summary.table$AvgApprovalTime, decreasing=TRUE),]
timeline.summary.table$DAC <- factor(timeline.summary.table$DAC, levels=unique(as.character(timeline.summary.table$DAC)))
p <- ggplot(data=timeline.summary.table, aes(x=DAC, y=AvgApprovalTime, fill = ToHighlight)) +
  geom_bar(stat="identity") +
  # geom_text(aes(label=paste(round(AvgApprovalTime,1),'days'))) +
  scale_y_continuous(breaks = seq(0, max(timeline.summary.table$AvgApprovalTime, na.rm = TRUE), by = 7)) +
  scale_fill_manual(values = c("yes"="cornflowerblue","no"="gray"), guide = FALSE) +
  coord_flip() +
  ylab("Average Approval Time (days)")
p
```

```{r include=FALSE}
# study.summary.table.ordered <- study.summary.table[order(-study.summary.table$TotalRequest),]
# total.approved.dar <- sum(study.summary.table.ordered$TotalApproved)
# total.dar.downloaded <- sum(study.summary.table.ordered$TotalDownload)
# download.percentage <- round(total.dar.downloaded*100/total.approved.dar,2)
# phs.popular.all <- study.summary.table.ordered[1,]['StudyAccesion']
# phs.popular.all.study.name <- study.summary.table.ordered[1,]['Study Name']
# phs.popular.all.dac <- study.summary.table.ordered[1,]['DAC']
# phs.popular.all.total.request <- study.summary.table.ordered[1,]['TotalRequest']

dac.study.summary.table <- study.summary.table[study.summary.table['DAC'] == dac,]
dac.study.summary.table.ordered <- dac.study.summary.table[order(-dac.study.summary.table$TotalRequest),]
phs.popular.this.dac <- dac.study.summary.table.ordered[1,]['StudyAccesion']
phs.popular.this.dac.study.name <- dac.study.summary.table.ordered[1,]['Study Name']
phs.popular.this.dac.total.request <- dac.study.summary.table.ordered[1,]['TotalRequest']
```


During this reporting period, study `r phs.popular.this.dac` (`r phs.popular.this.dac.study.name`) has been the most requested dataset from the `r dac` DAC with `r phs.popular.this.dac.total.request` requests. 

```{r include=FALSE}
fig2.caption <- sprintf("Comparison of Cummulative DAR Made to and Studies Released by %s",dac)
```

```{r fig.cap=fig2.caption, echo=FALSE, warning=FALSE ,message=FALSE, figures-side, fig.show="hold", out.width="50%"}
study.status.table.dac.plot <- ggplot(study.status.table.dac, aes(x=Month)) +
  geom_line(aes(y=TotalRequestsCummulative, colour="Total Requests"), size=2) +
  geom_line(aes(y=StudiesReleasedCummulative, colour="Studies Released"), size=2) +
  scale_color_manual("",
                     values = c("Total Requests"="cornflowerblue","Studies Released"="coral3")) +
  theme(legend.position = "bottom") +
  scale_x_date(date_breaks = "6 month", date_labels = '%m/%Y') +
  scale_y_continuous(n.breaks = 8) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  xlab("Year") +
  ylab("DAR Total / Studies Released")
  
rect2 <- data.frame(xmin=as.Date(lubridate::floor_date(as.Date(params$start.date))), xmax=as.Date(lubridate::floor_date(as.Date(params$end.date))), ymin=0, ymax=Inf)

study.status.table.dac.plot <- study.status.table.dac.plot + geom_rect(data=rect2, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax),
              color="gray20",
              alpha=0.2,
              inherit.aes = FALSE)
study.status.table.dac.plot
```

```{r fig.cap="Comparison of Cummulative DAR Made and Studies Released Per Month in current DAC", echo=FALSE, warning=FALSE ,message=FALSE, include=FALSE, fig.align="center"}
p <- ggplot(study.status.table.dac, aes(x=Month)) +
  geom_line(aes(y=TotalRequestsCummulative, colour="Total Requests"), size=2) +
  geom_line(aes(y=StudiesReleasedCummulative, colour="Studies Released"), size=2) +
  scale_color_manual("",
                     values = c("Total Requests"="cornflowerblue", "Studies Released"="coral3")) +
  theme(legend.position = "bottom") +
  scale_y_continuous(n.breaks = 8) +
  xlab("Year") +
  ylab("DAR Total / Studies Released")
  
rect <- data.frame(xmin=as.Date(lubridate::floor_date(as.Date(params$start.date))), xmax=as.Date(lubridate::floor_date(as.Date(params$end.date))), ymin=0, ymax=Inf)

p <- p + geom_rect(data=rect, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax),
              color="gray20",
              alpha=0.2,
              inherit.aes = FALSE)
p
```


```{r fig.cap="Moving Median of DAR from PI Submission to DAC Approval Time", echo=FALSE, warning=FALSE ,message=FALSE}
approval.time.table.plot <- ggplot(approval.time.moving.avg.table, aes(factor(ApprovedMonth), ApprovalTime)) +
  geom_boxplot(outlier.shape = NA) + 
  coord_cartesian(ylim = quantile(approval.time.moving.avg.table$ApprovalTime, c(0.1, 0.9))) +
  # scale_x_discrete(labels = format(as.Date(approval.time.moving.avg.table$ApprovedMonth), "%m/%Y")) +
  scale_y_continuous(n.breaks = 8) +
  stat_summary(fun=median, colour="cornflowerblue", aes(y=ApprovalTime,group=1),
               geom="line", group=1, size=2) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  xlab("Month") +
  ylab("Time (Days)")
  
approval.time.table.plot
```

```{r fig.cap="Moving Median of DAR from SO Approval to DAC Approval Time", echo=FALSE, warning=FALSE ,message=FALSE}
approval.time.from.SO.table.plot <- ggplot(approval.time.moving.avg.table, aes(factor(ApprovedMonth), ApprovalTimeFromSO)) +
  geom_boxplot(outlier.shape = NA) + 
  coord_cartesian(ylim = quantile(approval.time.moving.avg.table$ApprovalTimeFromSO, c(0.1, 0.9))) +
  scale_y_continuous(n.breaks = 8) +
  stat_summary(fun=median, colour="cornflowerblue", aes(y=ApprovalTimeFromSO,group=1),
               geom="line", group=1, size=2) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  xlab("Month") +
  ylab("Time (Days)")
  
approval.time.from.SO.table.plot
```


# Study Registrations

```{r echo=FALSE, warning=FALSE ,message=FALSE}

pi.submitted.to.current.dac.overall <- unique(nih_dac_action_table[nih_dac_action_table["DAC"] == dac,]$PI)
nih_dac_action_table_current <- get.df.within.range(nih_dac_action_table,start.date,end.date,date.col="Submitted by PI")
pi.submitted.to.current.dac.selected.time <- unique(nih_dac_action_table_current[nih_dac_action_table_current["DAC"] == dac,]$PI)
  
current.dac.pi.table <- subset(pi.requests.table.selected.time, PI %in% pi.submitted.to.current.dac.selected.time)
current.dac.pi.submit.to.more.than.one.dac <-  sum(current.dac.pi.table$DAC > 1)
current.dac.pi.average.dar <- round(mean(current.dac.pi.table$DAR),2)
current.dac.pi.average.dac <- round(mean(current.dac.pi.table$DAC),2)
current.dac.pi.average.project <- round(mean(current.dac.pi.table$Project),2)
```

Between `r start.date` and `r end.date`, `r length(pi.submitted.to.current.dac.selected.time)` PIs have submitted DAR to studies hosted by `r dac`. Among these PIs, `r current.dac.pi.submit.to.more.than.one.dac` have also submitted DAR to studies hosted by other DACs. PI who submitted DAR to `r dac` 
on average submits `r current.dac.pi.average.dar` DAR to `r current.dac.pi.average.dac` DACs for `r current.dac.pi.average.project` projects.


---
This report was prepared using the DACReportingTool package for R, build `r packageVersion("DACReportingTool")` by Mr. Hoyin Chu and Dr. Christopher Steven Marcum. 
